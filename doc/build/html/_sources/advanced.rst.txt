.. _advanced:

=====================================
Advanced Usage
=====================================

Introduction...

****************************
Range Dependent Analysis 
****************************

Using the :code:`--atmo-file` parameter defines a single atmospheric specification to use for a stratified atmospheric model.  In cases where propagation extends more than a few hundred kilometers, horizontal variations in the atmospheric structure can become significant.  Range dependent atmospheric structure can be used in infraGA/GeoAc via specification of an atmospheric file prefix as well as horizontal grid nodes.  An example 4x4 grid is provided in the examples/profs directory that includes 16 atmospheric files (example0.met, example1.met, example2.met, etc.) along with example_lat.dat and example_lon.dat that contain the latitude and longitude of the grid nodes.  

    .. code:: none

      infraga sph prop --atmo-prefix profs/example --grid-lats profs/example_lat.dat --grid-lons profs/example_lon.dat --src-lat 40.0 --src-lon -102.5 --azimuth -90.0 --z-grnd 1.0 


    .. code:: none

      	############################################
        ####     Running infraga-sph-rngdep     ####
        ####             Propagation            ####
        ############################################

      Interpolating atmosphere data in 'profs/example'* using format 'zTuvdp'...
        Setting grid node at (35, -110) with profile profs/example0.met
        Setting grid node at (35, -106.67) with profile profs/example1.met
        Setting grid node at (35, -103.33) with profile profs/example2.met
        ...
        Setting grid node at (38.33, -110) with profile profs/example4.met
        Setting grid node at (38.33, -106.67) with profile profs/example5.met
        Setting grid node at (38.33, -103.33) with profile profs/example6.met
        ...
        Setting grid node at (41.66, -110) with profile profs/example8.met
        Setting grid node at (41.66, -106.67) with profile profs/example9.met
        Setting grid node at (41.66, -103.33) with profile profs/example10.met
        ...

        Propagation region limits:
          latitude = 35.001, 44.999
          longitude = -109.999, -100.001
          altitude = 0, 150


      Parameter summary:
        inclination: 0.5, 45, 0.5
        azimuth: -90, -90, 1
        bounces: 2
        source location (lat, lon, alt): 40, -102.5, 1
        ground elevation: 1
        frequency: 0.1
        S&B atten coeff: 1
        write_atmo: false
        write_rays: true
        write_topo: false
        write_caustics: false
        calc_amp: true

      Calculating ray path: 0.5 degrees inclination, 90 degrees azimuth.
      Calculating ray path: 1 degrees inclination, 90 degrees azimuth.
      ...
      Calculating ray path: 44.5 degrees inclination, 90 degrees azimuth.
      Calculating ray path: 45 degrees inclination, 90 degrees azimuth.

Note that the various atmospheres are read in and set on the grid nodes in a specific order (cycling through longitude values first).  When using a user created grid it's useful to check that the atmospheric specifications are being ingested and set at the correct nodes.  A utility function is available to build a grid for range dependent analysis in :ref:`utilities`.

Visualization of range-dependent results is relatively straightforward and similar those doing so with stratified results; though, only one of the atmospheric files can be visualized so that the arrivals and ray path files must be specified directly.

  .. code:: none
    
    infraga plot azimuthal --atmo-file profs/example0.met --arrivals profs/example.arrivals.dat --ray-paths profs/example.raypaths.dat

  .. image:: _static/_images/rng-dep_azimuthal.png
      :width: 1200px
      :align: center


Although the range-dependent effects aren't overly obvious in this simulation due to the limited propagation range, comparison of the inclination angles and point-to-point propagation of the ray paths does exhibit variations.  Due to the added complexity of multi-variate interpolation needed to compute the gradients of the atmospheric parameters not only in the vertical direction but also in the horizontal, computation of range-dependent ray paths is notably slower than stratified analyses.

For global scale analyses (e.g., analysis of propagation paths from large bolides or volcanic eruptions), one can define a maximum propagation range greater than half of the circumference of the Earth (~24,000 km) so that the great circle distances never reach the break condition and use the :code:`--max-tm` parameter to define a maximum propagation time (defined in hours): :code:`--max-rng 25000 --max-tm 24.0 --bounces 1000`

  
****************************
Eigenray Analysis 
****************************

In some scenarios, those specific propagation paths connecting known source and receiver locations are of interest.  Such propagation paths are termed 'eigenrays' and can be difficult to compute when considering propagation paths in 3 dimensions including cross winds.  The auxiliary parameters that are utilized by infraGA/GeoAc for computation of the geometric spreading losses can also be leveraged for computation of launch angle changes that shift an arrival closer to a desired location.  A Levenberg-Marquardt (LM) algorithm has been implemented that uses the auxiliary paramaters for such a search.  The eigenray methods in infraGA/GeoAc are accessed using the :code:`eigenray` flag instead of :code:`prop` and have a number of common parameters.  In addition to specifying a source location, the receiver location is also needed.  The following command runs an eigenray search for a source at (30, -100) to a receiver to the west-south-west at (30.25, -104.25).  

  .. code::  none

    infraga sph eigenray --atmo-file ToyAtmo.met --src-lat 30.0 --src-lon -100.0 --rcvr-lat 30.25 --rcvr-lon -104.25 --bnc-max 1 --verbose True

Output printed to screen for this simulation is summarized below.  As with the :code:`prop` simulations, atmospheric data is ingested and interpolated to define the propagation medium and the parameter summary provides an overview of the run settings.  Several notable new parameters are included.  The :code:`--bnc-max` parameter specified above allows for 0 to that number of ground reflections.  In contrast to the :code:`prop` usage, the :code:`--bounces` option for the eigenray algorithm limits the analysis to that *specific* number of ground reflections (e.g., running analysis with :code:`--bounces 2` will run an eigenray search for only those paths with 2 ground reflections).  Though not adjusted above, the :code:`--damping` parameter listed below controls how rapidly the LM algorithm steps towards the solution and can be increased for stability of the search if necessary.  

  .. code:: none

      ###########################################
      ####        Running infraga-sph        ####
      ####          Eigenray Search          ####
      ###########################################

    Interpolating atmosphere data in 'ToyAtmo.met' using format 'zTuvdp'...
      Propagation region limits:
        latitude = -90, 90
        longitude = -180, 180
        altitude = 0, 139.9


    Parameter summary:
      source location (lat, lon, alt): 30, -100, 0
      receiver location (lat, lon, alt): 30.25, -104.25, 0
      inclination range: 0.5, 45
      bounces: 0, 1
      ground elevation: 0
      damping:0.001
      frequency: 0.1
      S&B atten coeff: 1
      verbose: true

    Searching for 0 bounce eigenrays.
      Estimating eigenray angles for source-receiver at great circle distance 409.604 km and azimuth -85.0442 degrees from N.  Inclination limits: [0.5, 45].
        Ray launched with inclination 0.5, azimuth -85.0442 arrives at range 216.761 km after 0 bounce(s).	Exact arrival at 30.1468 degrees N latitude, -102.247 degrees E longitude
        Ray launched with inclination 0.6, azimuth -85.0442 arrives at range 216.445 km after 0 bounce(s).	Exact arrival at 30.1466 degrees N latitude, -102.243 degrees E longitude
        ...
        Ray launched with inclination 35.8, azimuth -85.0442 arrives at range 410.169 km after 0 bounce(s).	Exact arrival at 30.24 degrees N latitude, -104.256 degrees E longitude
        Ray launched with inclination 35.9, azimuth -85.0442 arrives at range 408.259 km after 0 bounce(s).	Exact arrival at 30.239 degrees N latitude, -104.237 degrees E longitude
        Azimuth deviation = 0.163077, less than 2 degrees: estimates acceptable.

        Searching for exact eigenray using auxiliary parameters.
        Calculating ray path: 35.8 degrees inclination, -85.0442 degrees azimuth		Arrival at (30.240036, -104.25644), distance to receiver = 1.2688308 km.
        Calculating ray path: 35.831669 degrees inclination, -84.874356 degrees azimuth		Arrival at (30.249983, -104.24998), distance to receiver = 0.002455279 km.
        Eigenray-0:
          inclination [deg] = 35.831669
          azimuth [deg] = -84.874356
          bounces [-] = 0
          latitude [deg] = 30.249983
          longitude [deg] = -104.24998
          time [s] = 1503.657
          celerity [km/s] = 0.27240416
          turning height [km] = 130.22471
          arrival inclination [deg] = 35.84037
          back azimuth [deg] = 92.992416
          attenuation (geometric) [dB] = -54.837386
          absorption [dB] = -23.705732

    	Estimating eigenray angles for source-receiver at great circle distance 409.60414 km and azimuth -85.044241 degrees from N.  Inclination limits: [35.9, 45].
        Ray launched with inclination 35.9, azimuth -85.0442 arrives at range 408.259 km after 0 bounce(s).	Exact arrival at 30.239 degrees N latitude, -104.237 degrees E longitude
        ...
        Ray launched with inclination 44.9, azimuth -85.044241 arrives at range 314.57557 km after 0 bounce(s).	Exact arrival at 30.169893 degrees N latitude, -103.26423 degrees E longitude
        Reached maximum inclination angle or iteration limit.

    Searching for 1 bounce eigenrays.
      Estimating eigenray angles for source-receiver at great circle distance 409.60414 km and azimuth -85.044241 degrees from N.  Inclination limits: [0.5, 45].
        Ray launched with inclination 0.5, azimuth -85.044241 arrives at range 433.04978 km after 1 bounce(s).	Exact arrival at 30.255722 degrees N latitude, -104.49409 degrees E longitude
        Ray launched with inclination 0.6, azimuth -85.044241 arrives at range 432.46918 km after 1 bounce(s).	Exact arrival at 30.255473 degrees N latitude, -104.48806 degrees E longitude
        ...
        
    Identified 3 eigenray(s).

The methodology of infraGA/GeoAc's eigenray search is separated into two stages.  In the initial stage, rays are launched in the direction from the source to the receiver at increasing inclination angles.  Once a pair of rays are identified which pass over the receiver range, the LM algorithm is used to search for the exact eigenray.  The search is the resumed from the launch angle that triggered the LM search and these steps are repeated until the maximum inclination angle is reached.  The search then begins with an increased number of ground reflections and continues until the maximum number of such reflections is reached.

Discuss turning the :code:`--verbose` option off...

  .. code:: none

    ...
    Searching for 0 bounce eigenrays.
      Eigenray identified:	theta, phi = 35.831669, -84.874356 degrees.
    Searching for 1 bounce eigenrays.
      Eigenray identified:	theta, phi = 4.1392114, -84.970504 degrees.
      Eigenray identified:	theta, phi = 31.703267, -84.583914 degrees.
    Identified 3 eigenray(s).

Visualization methods (need to write them up first)...

  .. image:: _static/_images/eigenray1.png
      :width: 1200px
      :align: center


****************************
Waveform Calculations 
****************************

Discussion of waveform methods...

  .. code:: none

    infraga sph wnl-wvfrm --atmo-file ToyAtmo.met --src-lat 30.0 --src-lon -100.0 --bounces 1 --inclination 4.1392114 --azimuth -84.970504 --wvfrm-yield 10e3

  .. code:: none

      ###########################################
      ####        Running infraga-sph        ####
      ####     Weakly Non-Linear Waveform    ####
      ###########################################

    Interpolating atmosphere data in 'ToyAtmo.met' using format 'zTuvdp'...
      Propagation region limits:
        latitude = -90, 90
        longitude = -180, 180
        altitude = 0, 139.9


    Parameter summary:
      inclination: 4.13921
      azimuth: -84.9705
      bounces: 1
      source location (lat, lon, alt): 30, -100, 0
      ground elevation: 0
      frequency: 0.1
      S&B atten coeff: 1
      waveform option: impulse
      waveform p0: 2432.82
      waveform t0: 0.0890579
      waveform alpha: 0.01
      waveform reference location: 0.754052

    Calculating ray path geometry and weakly non-linear waveform evolution...
      Defining waveform from built in impulse with shaping parameter = 0.01.
      Generating waveform at ray length: 0	altitude: 0.0579589	scaled non-linearity factor: 0.0458741
      Generating waveform at ray length: 10	altitude: 1.32843	scaled non-linearity factor: 0.00360202
      ...
      Generating waveform at ray length: 110	altitude: 37.596	scaled non-linearity factor: 0.026272
      Caustic encountered.
      Generating waveform at ray length: 120	altitude: 36.9643	scaled non-linearity factor: 0.0178894
      ...
      Generating waveform at ray length: 440	altitude: 0.347231	scaled non-linearity factor: 0.000299998

      Arrival summary:
        latitude [deg] = 30.249997
        longitude [deg] = -104.25002
        time [s] = 1412.4271
        celerity [km/s] = 0.29000158
        turning height [km] = 37.596484
        arrival inclination [deg] = 4.1765906
        back azimuth [deg] = 92.895927
        trans. coeff. [dB] = -40.225568
        absorption [dB] = -0.14986747


Visualization methods (need to write them up first)...



************************************
Combined Eigenray + Waveform Methods
************************************

Discussion of eig_wvfrm methods...



Visualization...

  .. image:: _static/_images/eig_wvfrm1.png
      :width: 500px
      :align: center

Zooming in...

  .. image:: _static/_images/eig_wvfrm2.png
      :width: 500px
      :align: center

Zooming in...

  .. image:: _static/_images/eig_wvfrm3.png
      :width: 500px
      :align: center

Zooming in...

  .. image:: _static/_images/eig_wvfrm4.png
      :width: 500px
      :align: center




****************************
Including Reaslistic Terrain 
****************************

Discussion of how to include terrain...

